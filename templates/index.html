<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èšä¼šè°ƒé…’åŠ©æ‰‹ ğŸ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* Custom styles moved to static/css/style.css */
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">ğŸ¸ èšä¼šè°ƒé…’åŠ©æ‰‹</a>
    </div>
</nav>

<div class="container">
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="drink-tab" data-bs-toggle="tab" data-bs-target="#drink" type="button" role="tab">ğŸ¥‚ å–ç‚¹ä»€ä¹ˆ</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">ğŸ¾ é…’åº“ç®¡ç†</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button" role="tab">ğŸ‰ æ´»åŠ¨ç®¡ç†</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai" type="button" role="tab">ğŸ¤– è°ƒé…’åŠ©æ‰‹</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="participants-tab" data-bs-toggle="tab" data-bs-target="#participants" type="button" role="tab">ğŸ‘¥ æœ‹å‹ä»¬</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="recipes-tab" data-bs-toggle="tab" data-bs-target="#recipes" type="button" role="tab">ğŸ“œ é…æ–¹æœ¬</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="roulette-tab" data-bs-toggle="tab" data-bs-target="#roulette" type="button" role="tab">ğŸ² å¤§è½¬ç›˜</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <!-- Tab 1: å–ç‚¹ä»€ä¹ˆ -->
        <div class="tab-pane fade show active" id="drink" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-4">
                        <h4>è®°å½•ä¸€æ¯</h4>
                        <form action="/log_drink" method="POST">
                            <div class="mb-3">
                                <label class="form-label">å½“å‰æ´»åŠ¨ (å¯é€‰)</label>
                                <select class="form-select" name="event_id">
                                    <option value="" selected>ä¸å…³è”æ´»åŠ¨</option>
                                    {% for e in events %}
                                    <option value="{{ e.id }}">{{ e.name }} ({{ e.date }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è°å–çš„ï¼Ÿ</label>
                                <select class="form-select" name="participant_id" required>
                                    <option value="" selected disabled>é€‰æ‹©æœ‹å‹...</option>
                                    {% for p in participants %}
                                    <option value="{{ p.id }}">{{ p.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">å–äº†ä»€ä¹ˆï¼Ÿ</label>
                                <input type="text" class="form-control" name="drink_name" placeholder="ä¾‹å¦‚ï¼šMojito" list="recipe_list" required>
                                <datalist id="recipe_list">
                                    {% for r in recipes %}
                                    <option value="{{ r.name }}">
                                    {% endfor %}
                                </datalist>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">è®°ä¸‹æ¥ ğŸº</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-4">
                        <h4>ä»Šæ—¥æˆ˜å†µ</h4>
                        <ul class="list-group list-group-flush">
                            {% for p in participants %}
                                {% if p.consumptions %}
                                <li class="list-group-item">
                                    <strong>{{ p.name }}</strong> å–äº†:
                                    {% for c in p.consumptions %}
                                        <span class="badge bg-info text-dark">{{ c.drink_name }}</span>
                                    {% endfor %}
                                </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: é…’åº“ç®¡ç† -->
        <div class="tab-pane fade" id="inventory" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>æˆ‘çš„é…’åº“</h4>
                <button class="btn btn-success" onclick="openInventoryModal()">+ æ·»åŠ åº“å­˜</button>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="card p-4">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>åç§°</th>
                                    <th>åˆ†ç±»</th>
                                    <th>å¤‡æ³¨</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in inventory %}
                                <tr>
                                    <td>{{ item.name }}</td>
                                    <td><span class="badge bg-secondary">{{ item.category }}</span></td>
                                    <td>{{ item.quantity }}</td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">â‹®</button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="openInventoryModal('{{ item.id }}', '{{ item.name }}', '{{ item.category }}', '{{ item.quantity }}')">ç¼–è¾‘</a></li>
                                                <li>
                                                    <form action="/delete_inventory/{{ item.id }}" method="POST" onsubmit="return confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ');">
                                                        <button type="submit" class="dropdown-item text-danger">åˆ é™¤</button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-center text-muted">è¿˜æ²¡æœ‰åº“å­˜ï¼Œå¿«å»ä¹°é…’ï¼</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: æ´»åŠ¨ç®¡ç† -->
        <div class="tab-pane fade" id="events" role="tabpanel">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-4">
                        <h4>å‘èµ·æ–°æ´»åŠ¨</h4>
                        <form action="/create_event" method="POST">
                            <div class="mb-3">
                                <label class="form-label">æ´»åŠ¨åç§°</label>
                                <input type="text" class="form-control" name="name" placeholder="ä¾‹å¦‚ï¼šå‘¨æœ«å—¨çš®" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æ—¥æœŸ</label>
                                <input type="date" class="form-control" name="date">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æè¿°</label>
                                <textarea class="form-control" name="description" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-info text-white w-100">åˆ›å»ºæ´»åŠ¨ ğŸ‰</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card p-4">
                        <h4>æ´»åŠ¨åˆ—è¡¨</h4>
                        <div class="accordion" id="accordionEvents">
                            {% for event in events %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ event.id }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ event.id }}" aria-expanded="false" aria-controls="collapse{{ event.id }}">
                                        <strong>{{ event.name }}</strong> &nbsp; <small class="text-muted">({{ event.date }})</small>
                                    </button>
                                </h2>
                                <div id="collapse{{ event.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ event.id }}" data-bs-parent="#accordionEvents">
                                    <div class="accordion-body">
                                        <p>{{ event.description }}</p>
                                        <hr>
                                        <h5>ğŸ¥‚ é…’å• ({{ event.recipes|length }})</h5>
                                        <ul class="list-group mb-3">
                                            {% for r in event.recipes %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                {{ r.name }}
                                                <form action="/event/{{ event.id }}/remove_recipe" method="POST" class="d-inline">
                                                    <input type="hidden" name="recipe_id" value="{{ r.id }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">ç§»é™¤</button>
                                                </form>
                                            </li>
                                            {% else %}
                                            <li class="list-group-item text-muted">æš‚æ— é…’å•ï¼Œå¿«å»æ·»åŠ å§ï¼</li>
                                            {% endfor %}
                                        </ul>
                                        
                                        <form action="/event/{{ event.id }}/add_recipe" method="POST" class="row g-2">
                                            <div class="col-auto">
                                                <select class="form-select" name="recipe_id" required>
                                                    <option value="" selected disabled>æ·»åŠ é…æ–¹åˆ°é…’å•...</option>
                                                    {% for r in recipes %}
                                                    <option value="{{ r.id }}">{{ r.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-auto">
                                                <button type="submit" class="btn btn-outline-primary">æ·»åŠ </button>
                                            </div>
                                            <div class="col-auto">
                                                <a href="/event/{{ event.id }}/stats" target="_blank" class="btn btn-warning">ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡</a>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center text-muted my-5">æš‚æ— æ´»åŠ¨</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: è°ƒé…’åŠ©æ‰‹ -->
        <div class="tab-pane fade" id="ai" role="tabpanel">
            <div class="row">
                <div class="col-md-5">
                    <!-- Mode Selection -->
                    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pills-direct-tab" data-bs-toggle="pill" data-bs-target="#pills-direct" type="button">ğŸ¯ å…·ä½“è¦æ±‚</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-omakase-tab" data-bs-toggle="pill" data-bs-target="#pills-omakase" type="button">ğŸ¶ Omakase (å¿ƒæƒ…)</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="pills-tabContent">
                        <!-- Direct Mode -->
                        <div class="tab-pane fade show active" id="pills-direct" role="tabpanel">
                            <div class="card p-4">
                                <h4>æˆ‘æƒ³å–...</h4>
                                <p class="text-muted small">AI ä¼šæ ¹æ®ä½ çš„åº“å­˜ä¸ºä½ æ¨èã€‚</p>
                                <textarea id="userRequest" class="form-control mb-3" rows="4" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³å–ç‚¹é…¸ç”œå£å‘³çš„ï¼Œä¸è¦å¤ªçƒˆï¼Œæˆ–è€…æˆ‘æƒ³æ¶ˆè€—ä¸€ä¸‹é‚£ç“¶é‡‘é…’..."></textarea>
                                <button id="btnAskAI" class="btn btn-warning w-100">âœ¨ å¸®æˆ‘æ¨è</button>
                            </div>
                        </div>
                        
                        <!-- Omakase Mode -->
                        <div class="tab-pane fade" id="pills-omakase" role="tabpanel">
                            <div class="card p-4" style="background-color: #fdfbf7;">
                                <h4>Omakase Â· å¨å¸ˆå‘åŠ</h4>
                                <p class="text-muted small">æŠŠä¸€åˆ‡äº¤ç»™ Kenji å§ã€‚</p>
                                <div class="mb-3">
                                    <label class="form-label">ä»Šæ—¥å¿ƒæƒ…</label>
                                    <select class="form-select" id="omakaseMood">
                                        <option value="å¹³é™">ğŸ˜Œ å¹³é™ (Calm)</option>
                                        <option value="å¼€å¿ƒ">ğŸ˜„ å¼€å¿ƒ (Happy)</option>
                                        <option value="ç–²æƒ«">ğŸ˜« ç–²æƒ« (Tired)</option>
                                        <option value="å¿§éƒ">ğŸ˜” å¿§éƒ (Melancholy)</option>
                                        <option value="å…´å¥‹">ğŸ¤© å…´å¥‹ (Excited)</option>
                                        <option value="æƒ³é†‰">ğŸ¥´ æƒ³é†‰ (Wanna get drunk)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">çª—å¤–å¤©æ°”</label>
                                    <select class="form-select" id="omakaseWeather">
                                        <option value="æ™´æœ—">â˜€ï¸ æ™´æœ— (Sunny)</option>
                                        <option value="ä¸‹é›¨">ğŸŒ§ï¸ ä¸‹é›¨ (Rainy)</option>
                                        <option value="é˜´å¤©">â˜ï¸ é˜´å¤© (Cloudy)</option>
                                        <option value="ä¸‹é›ª">â„ï¸ ä¸‹é›ª (Snowy)</option>
                                        <option value="é—·çƒ­">ğŸ¥µ é—·çƒ­ (Humid)</option>
                                    </select>
                                </div>
                                <button id="btnOmakase" class="btn btn-dark w-100">ğŸ¥ƒ è¯· Kenji ç‰¹è°ƒ</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-7">
                    <div class="card p-4">
                        <h4>AI å»ºè®®</h4>
                        <div id="aiLoading" class="text-center d-none my-5">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2" id="loadingText">æ­£åœ¨æ€è€ƒé…æ–¹...</p>
                        </div>
                        <div id="aiResult" style="white-space: pre-wrap;"></div>
                        
                        <div id="saveRecipeArea" class="mt-3 d-none">
                            <hr>
                            <h5>ä¿å­˜è¿™ä¸ªé…æ–¹ï¼Ÿ</h5>
                            <form action="/save_recipe" method="POST">
                                <input type="hidden" name="name" id="saveName">
                                <input type="hidden" name="ingredients" id="saveIngredients">
                                <input type="hidden" name="instructions" id="saveInstructions">
                                <div class="mb-2">
                                    <label>ç»™å®ƒèµ·ä¸ªåå­—ï¼š</label>
                                    <input type="text" class="form-control" id="recipeNameInput" required>
                                </div>
                                <div class="mb-2">
                                    <label>æ·»åŠ åˆ°æ´»åŠ¨ (å¯é€‰)ï¼š</label>
                                    <select class="form-select" name="event_id">
                                        <option value="">ä¸æ·»åŠ </option>
                                        {% for e in events %}
                                        <option value="{{ e.id }}">{{ e.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="button" onclick="submitRecipe()" class="btn btn-outline-success btn-sm">ä¿å­˜åˆ°é…æ–¹æœ¬</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 5: æœ‹å‹ä»¬ -->
        <div class="tab-pane fade" id="participants" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-4">
                        <h4>æ·»åŠ æ–°æœ‹å‹</h4>
                        <form action="/add_participant" method="POST" class="d-flex gap-2">
                            <input type="text" class="form-control" name="name" placeholder="åå­—" required>
                            <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                        </form>
                    </div>
                    <div class="card p-4 mt-3">
                        <h4>æœ‹å‹åˆ—è¡¨</h4>
                        <ul class="list-group">
                            {% for p in participants %}
                            <li class="list-group-item">{{ p.name }}</li>
                            {% else %}
                            <li class="list-group-item text-muted">è¿˜æ²¡äººæ¥...</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 6: é…æ–¹æœ¬ -->
        <div class="tab-pane fade" id="recipes" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>æˆ‘çš„é…æ–¹</h4>
                <button class="btn btn-success" onclick="openRecipeModal()">+ æ–°å»ºé…æ–¹</button>
            </div>
            <div class="row">
                {% for r in recipes %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100" id="recipe-card-{{ r.id }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">{{ r.name }}</h5>
                                <div class="dropdown">
                                    <button class="btn btn-link text-secondary p-0" type="button" data-bs-toggle="dropdown">
                                        â‹®
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="openRecipeModal('{{ r.id }}', '{{ r.name }}', `{{ r.ingredients }}`, `{{ r.instructions }}`)">ç¼–è¾‘</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="generateRecipeImage('{{ r.id }}', '{{ r.name }}')">ğŸ“¸ ç”Ÿæˆå›¾ç‰‡</a></li>
                                        <li>
                                            <form action="/delete_recipe/{{ r.id }}" method="POST" onsubmit="return confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ');">
                                                <button type="submit" class="dropdown-item text-danger">åˆ é™¤</button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            {% if r.is_generated %}<span class="badge bg-warning text-dark mb-2">AI ç”Ÿæˆ</span>{% endif %}
                            <p class="card-text small" style="white-space: pre-wrap;">{{ r.ingredients }}</p>
                            <hr>
                            <p class="card-text small text-muted">{{ r.instructions }}</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12 text-center text-muted my-5">æš‚æ— é…æ–¹ï¼Œå» AI é‚£é‡Œç”Ÿæˆä¸€ä¸ªï¼Œæˆ–è€…æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªå§ï¼</div>
                {% endfor %}
            </div>
        </div>

        <!-- Tab 7: é¸¡å°¾é…’å¤§è½¬ç›˜ -->
        <div class="tab-pane fade" id="roulette" role="tabpanel">
            <div class="row justify-content-center">
                <div class="col-md-8 text-center">
                    <div class="card p-5" style="background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png'); color: #f4f1ea;">
                        <h2 class="mb-4" style="color: #c5a059;">ğŸ² å‘½è¿ä¹‹è½®</h2>
                        <p class="mb-5">ä¸çŸ¥é“å–ä»€ä¹ˆï¼Ÿäº¤ç»™å‘½è¿å§ï¼</p>
                        
                        <div id="roulette-wheel" class="mb-5 position-relative" style="height: 320px; width: 320px; margin: 0 auto; overflow: hidden;">
                            <!-- Canvas Wheel -->
                            <canvas id="wheelCanvas" width="320" height="320" style="width: 100%; height: 100%; transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);"></canvas>
                            <!-- Pointer -->
                            <div style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #c5a059; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); z-index: 10;"></div>
                        </div>

                        <div id="roulette-result" class="mb-4" style="min-height: 50px;">
                            <h3 class="text-warning d-none" id="result-text"></h3>
                        </div>

                        <div class="d-grid gap-2 col-6 mx-auto">
                            <button id="btnSpin" class="btn btn-warning btn-lg">ğŸ° å¼€å§‹æ—‹è½¬</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Recipe Modal -->
<div class="modal fade" id="recipeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/save_recipe" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="recipeModalTitle">æ–°å»ºé…æ–¹</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="recipe_id" id="modalRecipeId">
                    <div class="mb-3">
                        <label class="form-label">é…æ–¹åç§°</label>
                        <input type="text" class="form-control" name="name" id="modalRecipeName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">åŸæ–™</label>
                        <textarea class="form-control" name="ingredients" id="modalRecipeIngredients" rows="3" placeholder="ä¾‹å¦‚ï¼š45ml é‡‘é…’..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">åˆ¶ä½œæ­¥éª¤</label>
                        <textarea class="form-control" name="instructions" id="modalRecipeInstructions" rows="3" placeholder="ä¾‹å¦‚ï¼šæ‘‡å’Œæ³•..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Inventory Modal -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/save_inventory" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="inventoryModalTitle">æ·»åŠ åº“å­˜</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="item_id" id="modalItemId">
                    <div class="mb-3">
                        <label class="form-label">åç§°</label>
                        <input type="text" class="form-control" name="name" id="modalItemName" placeholder="ä¾‹å¦‚ï¼šAbsolut Vodka" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">åˆ†ç±»</label>
                        <select class="form-select" name="category" id="modalItemCategory" required>
                            <optgroup label="åŸºé…’ (Base Spirits)">
                                <option value="Whisky">å¨å£«å¿Œ (Whisky)</option>
                                <option value="Brandy">ç™½å…°åœ° (Brandy)</option>
                                <option value="Tequila">é¾™èˆŒå…° (Tequila)</option>
                                <option value="Gin">é‡‘é…’ (Gin)</option>
                                <option value="Rum">æœ—å§†é…’ (Rum)</option>
                                <option value="Vodka">ä¼ç‰¹åŠ  (Vodka)</option>
                                <option value="Base Spirit">å…¶ä»–åŸºé…’</option>
                            </optgroup>
                            <optgroup label="å…¶ä»–">
                                <option value="Liqueur">åˆ©å£é…’ (Liqueur)</option>
                                <option value="Wine">è‘¡è„é…’/èµ·æ³¡é…’ (Wine)</option>
                                <option value="Mixer">è½¯é¥®/è¾…æ–™ (Mixer)</option>
                                <option value="Garnish">è£…é¥° (Garnish)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä½™é‡/å¤‡æ³¨</label>
                        <input type="text" class="form-control" name="quantity" id="modalItemQuantity" placeholder="ä¾‹å¦‚ï¼š700ml">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function openInventoryModal(id, name, category, quantity) {
        const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
        const title = document.getElementById('inventoryModalTitle');
        const idInput = document.getElementById('modalItemId');
        const nameInput = document.getElementById('modalItemName');
        const categoryInput = document.getElementById('modalItemCategory');
        const quantityInput = document.getElementById('modalItemQuantity');

        if (id) {
            // Edit
            title.textContent = 'ç¼–è¾‘åº“å­˜';
            idInput.value = id;
            nameInput.value = name;
            categoryInput.value = category;
            quantityInput.value = quantity;
        } else {
            // Add
            title.textContent = 'æ·»åŠ åº“å­˜';
            idInput.value = '';
            nameInput.value = '';
            categoryInput.value = 'Whisky'; // default
            quantityInput.value = '';
        }
        modal.show();
    }
    function openRecipeModal(id, name, ingredients, instructions) {
        const modal = new bootstrap.Modal(document.getElementById('recipeModal'));
        const title = document.getElementById('recipeModalTitle');
        const idInput = document.getElementById('modalRecipeId');
        const nameInput = document.getElementById('modalRecipeName');
        const ingredientsInput = document.getElementById('modalRecipeIngredients');
        const instructionsInput = document.getElementById('modalRecipeInstructions');

        if (id) {
            // Edit Mode
            title.textContent = 'ç¼–è¾‘é…æ–¹';
            idInput.value = id;
            nameInput.value = name;
            ingredientsInput.value = ingredients;
            instructionsInput.value = instructions;
        } else {
            // Create Mode
            title.textContent = 'æ–°å»ºé…æ–¹';
            idInput.value = '';
            nameInput.value = '';
            ingredientsInput.value = '';
            instructionsInput.value = '';
        }
        
        modal.show();
    }

    // Unified AI Request Function
    function requestAI(endpoint, formData, loadingMsg="æ­£åœ¨æ€è€ƒé…æ–¹...") {
        const resultDiv = document.getElementById('aiResult');
        const loadingDiv = document.getElementById('aiLoading');
        const loadingText = document.getElementById('loadingText');
        const saveArea = document.getElementById('saveRecipeArea');

        resultDiv.innerHTML = '';
        saveArea.classList.add('d-none');
        loadingDiv.classList.remove('d-none');
        loadingText.innerText = loadingMsg;

        fetch(endpoint, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingDiv.classList.add('d-none');
            
            if (data.error) {
                resultDiv.innerHTML = '<span class="text-danger">å‡ºé”™äº†: ' + data.error + '</span>';
                return;
            }

            // Construct Display HTML based on JSON data
            let htmlContent = '';
            
            // Comment (for Omakase or general comment)
            if (data.comment) {
                htmlContent += `<div class="mb-3 fst-italic text-secondary" style="border-left: 3px solid #c5a059; padding-left: 10px;">${data.comment.replace(/\n/g, '<br>')}</div>`;
            }
            
            // Name
            if (data.name) {
                htmlContent += `<h5 class="text-dark fw-bold mb-3">ğŸ¸ ${data.name}</h5>`;
            }
            
            // Ingredients
            if (data.ingredients) {
                htmlContent += `<h6>ğŸ“ é…æ–¹ï¼š</h6><p class="small mb-3" style="white-space: pre-wrap;">${data.ingredients}</p>`;
            }
            
            // Instructions
            if (data.instructions) {
                htmlContent += `<h6>ğŸ¥£ æ­¥éª¤ï¼š</h6><p class="small text-muted" style="white-space: pre-wrap;">${data.instructions}</p>`;
            }
            
            // Ending (Omakase specific)
            if (data.ending) {
                htmlContent += `<div class="mt-3 text-end small text-secondary">"${data.ending}"</div>`;
            }
            
            // Fallback if data is not structured properly (e.g. error message string in name)
            if (!htmlContent) {
                htmlContent = JSON.stringify(data);
            }

            resultDiv.innerHTML = htmlContent;
            
            // Fill Hidden Inputs for Save
            document.getElementById('saveName').value = data.name || "æœªå‘½åé…æ–¹";
            document.getElementById('saveIngredients').value = data.ingredients || "";
            document.getElementById('saveInstructions').value = data.instructions || "";
            
            // Fill Visible Name Input
            document.getElementById('recipeNameInput').value = data.name || "";
            
            saveArea.classList.remove('d-none');
        })
        .catch(err => {
            loadingDiv.classList.add('d-none');
            resultDiv.innerHTML = 'å‡ºé”™äº†: ' + err;
        });
    }

    // Direct Ask
    document.getElementById('btnAskAI').addEventListener('click', function() {
        const req = document.getElementById('userRequest').value;
        const formData = new FormData();
        formData.append('user_request', req);
        requestAI('/suggest', formData);
    });

    // Omakase Ask
    document.getElementById('btnOmakase').addEventListener('click', function() {
        const mood = document.getElementById('omakaseMood').value;
        const weather = document.getElementById('omakaseWeather').value;
        const formData = new FormData();
        formData.append('mood', mood);
        formData.append('weather', weather);
        requestAI('/omakase', formData, "Kenji æ­£åœ¨æ“¦æ‹­é…’æ¯ï¼Œæ€è€ƒäººç”Ÿ...");
    });

    function submitRecipe() {
        const name = document.getElementById('recipeNameInput').value;
        if(!name) { alert('è¯·å¡«å†™é…æ–¹åç§°'); return; }
        
        document.getElementById('saveName').value = name;
        // æäº¤è¡¨å•
        document.querySelector('#saveRecipeArea form').submit();
    }
    
    // Generate Recipe Card Image
    function generateRecipeImage(recipeId, recipeName) {
        const card = document.getElementById('recipe-card-' + recipeId);
        if (!card) {
            alert('æœªæ‰¾åˆ°é…æ–¹å¡ç‰‡');
            return;
        }
        
        // Temporarily hide the dropdown button for cleaner image
        const dropdown = card.querySelector('.dropdown');
        const originalDisplay = dropdown.style.display;
        dropdown.style.display = 'none';
        
        html2canvas(card, {
            scale: 2,
            backgroundColor: '#ffffff',
            logging: false,
            windowWidth: card.scrollWidth,
            windowHeight: card.scrollHeight
        }).then(canvas => {
            // Restore dropdown
            dropdown.style.display = originalDisplay;
            
            // Convert to blob and download
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const fileName = recipeName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_') + '.png';
                link.download = fileName;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            });
        }).catch(err => {
            dropdown.style.display = originalDisplay;
            alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥: ' + err.message);
        });
    }
    
    // Auto-activate tab based on URL hash
    document.addEventListener("DOMContentLoaded", function() {
        var hash = window.location.hash;
        if (hash) {
            var triggerEl = document.querySelector('.nav-link[data-bs-target="' + hash + '"]');
            if (triggerEl) {
                var tab = new bootstrap.Tab(triggerEl);
                tab.show();
            }
        }
        
        // Initialize Roulette
        initRoulette();
    });

    // Roulette Logic
    let wheelRecipes = [];
    
    function initRoulette() {
        // Collect recipes from the recipe list
        // In a real scenario, this might come from an API, but we can parse the DOM for simplicity or inject JSON
        // Let's inject JSON for reliability
        wheelRecipes = [
            {% for r in recipes %}
            "{{ r.name }}",
            {% endfor %}
        ];
        
        if (wheelRecipes.length < 2) {
            wheelRecipes = ["Gin Tonic", "Mojito", "Highball", "Whisky Sour", "Martini", "Negroni"]; // Fallback defaults
        }
        
        drawWheel();
    }
    
    function drawWheel() {
        const canvas = document.getElementById('wheelCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const cx = width / 2;
        const cy = height / 2;
        const radius = width / 2 - 10; // Margin for border
        
        ctx.clearRect(0, 0, width, height);
        
        // Japanese Traditional Colors
        const colors = [
            '#8e2936', // ç»¯è‰² (Deep Red)
            '#1e50a2', // ç‰ç’ƒè‰² (Deep Blue)
            '#d0af4c', // èŠ¥å­è‰² (Mustard)
            '#5c7a29', // æŠ¹èŒ¶è‰² (Matcha Green)
            '#5b3e78', // èŒ„å­è‰² (Deep Purple)
            '#583822', // ç„¦èŒ¶è‰² (Dark Brown)
            '#2f5d50', // é“çº³æˆ· (Teal)
            '#ca8269'  // æ´—æœ± (Pale Vermilion)
        ];
        
        const numSegments = wheelRecipes.length;
        const arc = 2 * Math.PI / numSegments;
        
        // Draw Segments
        for (let i = 0; i < numSegments; i++) {
            const angle = i * arc - Math.PI / 2; // Start from top (-90deg)
            
            ctx.beginPath();
            ctx.fillStyle = colors[i % colors.length];
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, radius, angle, angle + arc);
            ctx.lineTo(cx, cy);
            ctx.fill();
            
            // Segment Border
            ctx.strokeStyle = '#c5a059';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw Text
            ctx.save();
            ctx.fillStyle = '#f4f1ea';
            ctx.font = 'bold 14px "Noto Serif SC", serif';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            
            const textAngle = angle + arc / 2;
            ctx.translate(cx + Math.cos(textAngle) * (radius - 20), cy + Math.sin(textAngle) * (radius - 20));
            ctx.rotate(textAngle);
            
            const text = wheelRecipes[i];
            // Truncate if too long
            const maxTextWidth = radius * 0.65;
            let displayText = text;
            if (ctx.measureText(displayText).width > maxTextWidth) {
                while (ctx.measureText(displayText + '...').width > maxTextWidth && displayText.length > 0) {
                    displayText = displayText.slice(0, -1);
                }
                displayText += '...';
            }
            
            ctx.fillText(displayText, 0, 0);
            ctx.restore();
        }
        
        // Draw Outer Border
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
        ctx.lineWidth = 8;
        ctx.strokeStyle = '#c5a059';
        ctx.stroke();
        
        // Draw Inner Center Circle
        ctx.beginPath();
        ctx.arc(cx, cy, 25, 0, 2 * Math.PI);
        ctx.fillStyle = '#333';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = '#c5a059';
        ctx.stroke();
        
        // Decorative Center Star
        ctx.beginPath();
        ctx.arc(cx, cy, 8, 0, 2 * Math.PI);
        ctx.fillStyle = '#c5a059';
        ctx.fill();
    }
    
    let currentRotation = 0;
    
    document.getElementById('btnSpin').addEventListener('click', function() {
        const canvas = document.getElementById('wheelCanvas');
        const resultText = document.getElementById('result-text');
        const btn = document.getElementById('btnSpin');
        
        resultText.classList.add('d-none');
        btn.disabled = true;
        
        // Random spin
        const numSegments = wheelRecipes.length;
        const segmentAngleDeg = 360 / numSegments;
        const randomSegmentIndex = Math.floor(Math.random() * numSegments);
        
        // Calculate stop angle to point to the chosen segment at TOP
        // Since we drew segment 0 starting at -90deg (12 o'clock), 
        // to get segment i to top, we need to rotate negative direction or adjust target
        // Let's simplify: 
        // We rotate the CANVAS. 
        // If we rotate N degrees clockwise, the segment at -N degrees moves to top.
        // Segment i center is at: -90 + i*arc + arc/2 (degrees)
        // We want this angle to end up at -90 (or 270) after rotation.
        // Rotation + (StartAngle) = TargetPosition
        // We want TargetPosition = 270 (Top)
        // StartAngle of segment center = i * segmentAngle + segmentAngle/2
        // We draw starting at -90. So visual angle is i * segmentAngle.
        // Actually, let's just use the visual rotation logic.
        // To land on index i:
        // The pointer is fixed at top.
        // Segment 0 is at [0, arc].
        // To bring segment i to top, we need to rotate the wheel such that segment i is at top.
        // Top is 270deg or -90deg.
        // Segment i starts at i*arc.
        // We need to rotate by: 360 - (i * segmentAngle + segmentAngle/2) + extra spins
        
        const segmentCenterAngle = randomSegmentIndex * segmentAngleDeg + segmentAngleDeg / 2;
        const stopAngle = 360 - segmentCenterAngle; // Degrees to rotate to bring this to 0 (which is top in our draw logic? Wait, we drew 0 at -90)
        
        // Correction: In drawWheel, segment 0 starts at -90 (Top).
        // So segment 0 is ALREADY at top.
        // Segment i is at (i * segmentAngle) clockwise from top.
        // To bring segment i to top, we must rotate COUNTER-CLOCKWISE by (i * segmentAngle)
        // OR rotate CLOCKWISE by (360 - i * segmentAngle).
        // Let's target the center of the segment.
        
        const targetRotation = 360 - (randomSegmentIndex * segmentAngleDeg + segmentAngleDeg / 2);
        const spinDegrees = 1800 + targetRotation + (Math.random() * 10 - 5); // 5 full spins + target + jitter
        
        currentRotation += spinDegrees;
        
        // Adjust for cumulative rotation to keep it clean (optional, but CSS transform handles large numbers fine)
        
        canvas.style.transform = `rotate(${currentRotation}deg)`;
        
        setTimeout(() => {
            const winner = wheelRecipes[randomSegmentIndex];
            resultText.innerText = `ğŸ‰ å‘½è¿é€‰æ‹©äº†ï¼š${winner}ï¼`;
            resultText.classList.remove('d-none');
            resultText.classList.add('fade-in');
            btn.disabled = false;
        }, 4000);
    });
</script>
</body>
</html>
