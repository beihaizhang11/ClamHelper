<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èšä¼šè°ƒé…’åŠ©æ‰‹ ğŸ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        /* Custom styles moved to static/css/style.css */
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">ğŸ¸ èšä¼šè°ƒé…’åŠ©æ‰‹</a>
    </div>
</nav>

<div class="container">
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="drink-tab" data-bs-toggle="tab" data-bs-target="#drink" type="button" role="tab">ğŸ¥‚ å–ç‚¹ä»€ä¹ˆ</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">ğŸ¾ é…’åº“ç®¡ç†</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button" role="tab">ğŸ‰ æ´»åŠ¨ç®¡ç†</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai" type="button" role="tab">ğŸ¤– è°ƒé…’åŠ©æ‰‹</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="participants-tab" data-bs-toggle="tab" data-bs-target="#participants" type="button" role="tab">ğŸ‘¥ æœ‹å‹ä»¬</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="recipes-tab" data-bs-toggle="tab" data-bs-target="#recipes" type="button" role="tab">ğŸ“œ é…æ–¹æœ¬</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <!-- Tab 1: å–ç‚¹ä»€ä¹ˆ -->
        <div class="tab-pane fade show active" id="drink" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-4">
                        <h4>è®°å½•ä¸€æ¯</h4>
                        <form action="/log_drink" method="POST">
                            <div class="mb-3">
                                <label class="form-label">å½“å‰æ´»åŠ¨ (å¯é€‰)</label>
                                <select class="form-select" name="event_id">
                                    <option value="" selected>ä¸å…³è”æ´»åŠ¨</option>
                                    {% for e in events %}
                                    <option value="{{ e.id }}">{{ e.name }} ({{ e.date }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è°å–çš„ï¼Ÿ</label>
                                <select class="form-select" name="participant_id" required>
                                    <option value="" selected disabled>é€‰æ‹©æœ‹å‹...</option>
                                    {% for p in participants %}
                                    <option value="{{ p.id }}">{{ p.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">å–äº†ä»€ä¹ˆï¼Ÿ</label>
                                <input type="text" class="form-control" name="drink_name" placeholder="ä¾‹å¦‚ï¼šMojito" list="recipe_list" required>
                                <datalist id="recipe_list">
                                    {% for r in recipes %}
                                    <option value="{{ r.name }}">
                                    {% endfor %}
                                </datalist>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">è®°ä¸‹æ¥ ğŸº</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-4">
                        <h4>ä»Šæ—¥æˆ˜å†µ</h4>
                        <ul class="list-group list-group-flush">
                            {% for p in participants %}
                                {% if p.consumptions %}
                                <li class="list-group-item">
                                    <strong>{{ p.name }}</strong> å–äº†:
                                    {% for c in p.consumptions %}
                                        <span class="badge bg-info text-dark">{{ c.drink_name }}</span>
                                    {% endfor %}
                                </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: é…’åº“ç®¡ç† -->
        <div class="tab-pane fade" id="inventory" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>æˆ‘çš„é…’åº“</h4>
                <button class="btn btn-success" onclick="openInventoryModal()">+ æ·»åŠ åº“å­˜</button>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="card p-4">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>åç§°</th>
                                    <th>åˆ†ç±»</th>
                                    <th>å¤‡æ³¨</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in inventory %}
                                <tr>
                                    <td>{{ item.name }}</td>
                                    <td><span class="badge bg-secondary">{{ item.category }}</span></td>
                                    <td>{{ item.quantity }}</td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">â‹®</button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="openInventoryModal('{{ item.id }}', '{{ item.name }}', '{{ item.category }}', '{{ item.quantity }}')">ç¼–è¾‘</a></li>
                                                <li>
                                                    <form action="/delete_inventory/{{ item.id }}" method="POST" onsubmit="return confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ');">
                                                        <button type="submit" class="dropdown-item text-danger">åˆ é™¤</button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-center text-muted">è¿˜æ²¡æœ‰åº“å­˜ï¼Œå¿«å»ä¹°é…’ï¼</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: æ´»åŠ¨ç®¡ç† -->
        <div class="tab-pane fade" id="events" role="tabpanel">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-4">
                        <h4>å‘èµ·æ–°æ´»åŠ¨</h4>
                        <form action="/create_event" method="POST">
                            <div class="mb-3">
                                <label class="form-label">æ´»åŠ¨åç§°</label>
                                <input type="text" class="form-control" name="name" placeholder="ä¾‹å¦‚ï¼šå‘¨æœ«å—¨çš®" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æ—¥æœŸ</label>
                                <input type="date" class="form-control" name="date">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æè¿°</label>
                                <textarea class="form-control" name="description" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-info text-white w-100">åˆ›å»ºæ´»åŠ¨ ğŸ‰</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card p-4">
                        <h4>æ´»åŠ¨åˆ—è¡¨</h4>
                        <div class="accordion" id="accordionEvents">
                            {% for event in events %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ event.id }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ event.id }}" aria-expanded="false" aria-controls="collapse{{ event.id }}">
                                        <strong>{{ event.name }}</strong> &nbsp; <small class="text-muted">({{ event.date }})</small>
                                    </button>
                                </h2>
                                <div id="collapse{{ event.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ event.id }}" data-bs-parent="#accordionEvents">
                                    <div class="accordion-body">
                                        <p>{{ event.description }}</p>
                                        <hr>
                                        <h5>ğŸ¥‚ é…’å• ({{ event.recipes|length }})</h5>
                                        <ul class="list-group mb-3">
                                            {% for r in event.recipes %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                {{ r.name }}
                                                <form action="/event/{{ event.id }}/remove_recipe" method="POST" class="d-inline">
                                                    <input type="hidden" name="recipe_id" value="{{ r.id }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">ç§»é™¤</button>
                                                </form>
                                            </li>
                                            {% else %}
                                            <li class="list-group-item text-muted">æš‚æ— é…’å•ï¼Œå¿«å»æ·»åŠ å§ï¼</li>
                                            {% endfor %}
                                        </ul>
                                        
                                        <form action="/event/{{ event.id }}/add_recipe" method="POST" class="row g-2">
                                            <div class="col-auto">
                                                <select class="form-select" name="recipe_id" required>
                                                    <option value="" selected disabled>æ·»åŠ é…æ–¹åˆ°é…’å•...</option>
                                                    {% for r in recipes %}
                                                    <option value="{{ r.id }}">{{ r.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-auto">
                                                <button type="submit" class="btn btn-outline-primary">æ·»åŠ </button>
                                            </div>
                                            <div class="col-auto">
                                                <a href="/event/{{ event.id }}/stats" target="_blank" class="btn btn-warning">ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡</a>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center text-muted my-5">æš‚æ— æ´»åŠ¨</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: è°ƒé…’åŠ©æ‰‹ -->
        <div class="tab-pane fade" id="ai" role="tabpanel">
            <div class="row">
                <div class="col-md-5">
                    <!-- Mode Selection -->
                    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pills-direct-tab" data-bs-toggle="pill" data-bs-target="#pills-direct" type="button">ğŸ¯ å…·ä½“è¦æ±‚</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-omakase-tab" data-bs-toggle="pill" data-bs-target="#pills-omakase" type="button">ğŸ¶ Omakase (å¿ƒæƒ…)</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="pills-tabContent">
                        <!-- Direct Mode -->
                        <div class="tab-pane fade show active" id="pills-direct" role="tabpanel">
                            <div class="card p-4">
                                <h4>æˆ‘æƒ³å–...</h4>
                                <p class="text-muted small">AI ä¼šæ ¹æ®ä½ çš„åº“å­˜ä¸ºä½ æ¨èã€‚</p>
                                <textarea id="userRequest" class="form-control mb-3" rows="4" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³å–ç‚¹é…¸ç”œå£å‘³çš„ï¼Œä¸è¦å¤ªçƒˆï¼Œæˆ–è€…æˆ‘æƒ³æ¶ˆè€—ä¸€ä¸‹é‚£ç“¶é‡‘é…’..."></textarea>
                                <button id="btnAskAI" class="btn btn-warning w-100">âœ¨ å¸®æˆ‘æ¨è</button>
                            </div>
                        </div>
                        
                        <!-- Omakase Mode -->
                        <div class="tab-pane fade" id="pills-omakase" role="tabpanel">
                            <div class="card p-4" style="background-color: #fdfbf7;">
                                <h4>Omakase Â· å¨å¸ˆå‘åŠ</h4>
                                <p class="text-muted small">æŠŠä¸€åˆ‡äº¤ç»™ Kenji å§ã€‚</p>
                                <div class="mb-3">
                                    <label class="form-label">ä»Šæ—¥å¿ƒæƒ…</label>
                                    <select class="form-select" id="omakaseMood">
                                        <option value="å¹³é™">ğŸ˜Œ å¹³é™ (Calm)</option>
                                        <option value="å¼€å¿ƒ">ğŸ˜„ å¼€å¿ƒ (Happy)</option>
                                        <option value="ç–²æƒ«">ğŸ˜« ç–²æƒ« (Tired)</option>
                                        <option value="å¿§éƒ">ğŸ˜” å¿§éƒ (Melancholy)</option>
                                        <option value="å…´å¥‹">ğŸ¤© å…´å¥‹ (Excited)</option>
                                        <option value="æƒ³é†‰">ğŸ¥´ æƒ³é†‰ (Wanna get drunk)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">çª—å¤–å¤©æ°”</label>
                                    <select class="form-select" id="omakaseWeather">
                                        <option value="æ™´æœ—">â˜€ï¸ æ™´æœ— (Sunny)</option>
                                        <option value="ä¸‹é›¨">ğŸŒ§ï¸ ä¸‹é›¨ (Rainy)</option>
                                        <option value="é˜´å¤©">â˜ï¸ é˜´å¤© (Cloudy)</option>
                                        <option value="ä¸‹é›ª">â„ï¸ ä¸‹é›ª (Snowy)</option>
                                        <option value="é—·çƒ­">ğŸ¥µ é—·çƒ­ (Humid)</option>
                                    </select>
                                </div>
                                <button id="btnOmakase" class="btn btn-dark w-100">ğŸ¥ƒ è¯· Kenji ç‰¹è°ƒ</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-7">
                    <div class="card p-4">
                        <h4>AI å»ºè®®</h4>
                        <div id="aiLoading" class="text-center d-none my-5">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2" id="loadingText">æ­£åœ¨æ€è€ƒé…æ–¹...</p>
                        </div>
                        <div id="aiResult" style="white-space: pre-wrap;"></div>
                        
                        <div id="saveRecipeArea" class="mt-3 d-none">
                            <hr>
                            <h5>ä¿å­˜è¿™ä¸ªé…æ–¹ï¼Ÿ</h5>
                            <form action="/save_recipe" method="POST">
                                <input type="hidden" name="name" id="saveName">
                                <input type="hidden" name="ingredients" id="saveIngredients">
                                <input type="hidden" name="instructions" id="saveInstructions">
                                <div class="mb-2">
                                    <label>ç»™å®ƒèµ·ä¸ªåå­—ï¼š</label>
                                    <input type="text" class="form-control" id="recipeNameInput" required>
                                </div>
                                <div class="mb-2">
                                    <label>æ·»åŠ åˆ°æ´»åŠ¨ (å¯é€‰)ï¼š</label>
                                    <select class="form-select" name="event_id">
                                        <option value="">ä¸æ·»åŠ </option>
                                        {% for e in events %}
                                        <option value="{{ e.id }}">{{ e.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="button" onclick="submitRecipe()" class="btn btn-outline-success btn-sm">ä¿å­˜åˆ°é…æ–¹æœ¬</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 5: æœ‹å‹ä»¬ -->
        <div class="tab-pane fade" id="participants" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-4">
                        <h4>æ·»åŠ æ–°æœ‹å‹</h4>
                        <form action="/add_participant" method="POST" class="d-flex gap-2">
                            <input type="text" class="form-control" name="name" placeholder="åå­—" required>
                            <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                        </form>
                    </div>
                    <div class="card p-4 mt-3">
                        <h4>æœ‹å‹åˆ—è¡¨</h4>
                        <ul class="list-group">
                            {% for p in participants %}
                            <li class="list-group-item">{{ p.name }}</li>
                            {% else %}
                            <li class="list-group-item text-muted">è¿˜æ²¡äººæ¥...</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 6: é…æ–¹æœ¬ -->
        <div class="tab-pane fade" id="recipes" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>æˆ‘çš„é…æ–¹</h4>
                <button class="btn btn-success" onclick="openRecipeModal()">+ æ–°å»ºé…æ–¹</button>
            </div>
            <div class="row">
                {% for r in recipes %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">{{ r.name }}</h5>
                                <div class="dropdown">
                                    <button class="btn btn-link text-secondary p-0" type="button" data-bs-toggle="dropdown">
                                        â‹®
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="openRecipeModal('{{ r.id }}', '{{ r.name }}', `{{ r.ingredients }}`, `{{ r.instructions }}`)">ç¼–è¾‘</a></li>
                                        <li>
                                            <form action="/delete_recipe/{{ r.id }}" method="POST" onsubmit="return confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ');">
                                                <button type="submit" class="dropdown-item text-danger">åˆ é™¤</button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            {% if r.is_generated %}<span class="badge bg-warning text-dark mb-2">AI ç”Ÿæˆ</span>{% endif %}
                            <p class="card-text small" style="white-space: pre-wrap;">{{ r.ingredients }}</p>
                            <hr>
                            <p class="card-text small text-muted">{{ r.instructions }}</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12 text-center text-muted my-5">æš‚æ— é…æ–¹ï¼Œå» AI é‚£é‡Œç”Ÿæˆä¸€ä¸ªï¼Œæˆ–è€…æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªå§ï¼</div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<!-- Recipe Modal -->
<div class="modal fade" id="recipeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/save_recipe" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="recipeModalTitle">æ–°å»ºé…æ–¹</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="recipe_id" id="modalRecipeId">
                    <div class="mb-3">
                        <label class="form-label">é…æ–¹åç§°</label>
                        <input type="text" class="form-control" name="name" id="modalRecipeName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">åŸæ–™</label>
                        <textarea class="form-control" name="ingredients" id="modalRecipeIngredients" rows="3" placeholder="ä¾‹å¦‚ï¼š45ml é‡‘é…’..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">åˆ¶ä½œæ­¥éª¤</label>
                        <textarea class="form-control" name="instructions" id="modalRecipeInstructions" rows="3" placeholder="ä¾‹å¦‚ï¼šæ‘‡å’Œæ³•..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Inventory Modal -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/save_inventory" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="inventoryModalTitle">æ·»åŠ åº“å­˜</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="item_id" id="modalItemId">
                    <div class="mb-3">
                        <label class="form-label">åç§°</label>
                        <input type="text" class="form-control" name="name" id="modalItemName" placeholder="ä¾‹å¦‚ï¼šAbsolut Vodka" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">åˆ†ç±»</label>
                        <select class="form-select" name="category" id="modalItemCategory" required>
                            <optgroup label="åŸºé…’ (Base Spirits)">
                                <option value="Whisky">å¨å£«å¿Œ (Whisky)</option>
                                <option value="Brandy">ç™½å…°åœ° (Brandy)</option>
                                <option value="Tequila">é¾™èˆŒå…° (Tequila)</option>
                                <option value="Gin">é‡‘é…’ (Gin)</option>
                                <option value="Rum">æœ—å§†é…’ (Rum)</option>
                                <option value="Vodka">ä¼ç‰¹åŠ  (Vodka)</option>
                                <option value="Base Spirit">å…¶ä»–åŸºé…’</option>
                            </optgroup>
                            <optgroup label="å…¶ä»–">
                                <option value="Liqueur">åˆ©å£é…’ (Liqueur)</option>
                                <option value="Wine">è‘¡è„é…’/èµ·æ³¡é…’ (Wine)</option>
                                <option value="Mixer">è½¯é¥®/è¾…æ–™ (Mixer)</option>
                                <option value="Garnish">è£…é¥° (Garnish)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä½™é‡/å¤‡æ³¨</label>
                        <input type="text" class="form-control" name="quantity" id="modalItemQuantity" placeholder="ä¾‹å¦‚ï¼š700ml">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function openInventoryModal(id, name, category, quantity) {
        const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
        const title = document.getElementById('inventoryModalTitle');
        const idInput = document.getElementById('modalItemId');
        const nameInput = document.getElementById('modalItemName');
        const categoryInput = document.getElementById('modalItemCategory');
        const quantityInput = document.getElementById('modalItemQuantity');

        if (id) {
            // Edit
            title.textContent = 'ç¼–è¾‘åº“å­˜';
            idInput.value = id;
            nameInput.value = name;
            categoryInput.value = category;
            quantityInput.value = quantity;
        } else {
            // Add
            title.textContent = 'æ·»åŠ åº“å­˜';
            idInput.value = '';
            nameInput.value = '';
            categoryInput.value = 'Whisky'; // default
            quantityInput.value = '';
        }
        modal.show();
    }
    function openRecipeModal(id, name, ingredients, instructions) {
        const modal = new bootstrap.Modal(document.getElementById('recipeModal'));
        const title = document.getElementById('recipeModalTitle');
        const idInput = document.getElementById('modalRecipeId');
        const nameInput = document.getElementById('modalRecipeName');
        const ingredientsInput = document.getElementById('modalRecipeIngredients');
        const instructionsInput = document.getElementById('modalRecipeInstructions');

        if (id) {
            // Edit Mode
            title.textContent = 'ç¼–è¾‘é…æ–¹';
            idInput.value = id;
            nameInput.value = name;
            ingredientsInput.value = ingredients;
            instructionsInput.value = instructions;
        } else {
            // Create Mode
            title.textContent = 'æ–°å»ºé…æ–¹';
            idInput.value = '';
            nameInput.value = '';
            ingredientsInput.value = '';
            instructionsInput.value = '';
        }
        
        modal.show();
    }

    // Unified AI Request Function
    function requestAI(endpoint, formData, loadingMsg="æ­£åœ¨æ€è€ƒé…æ–¹...") {
        const resultDiv = document.getElementById('aiResult');
        const loadingDiv = document.getElementById('aiLoading');
        const loadingText = document.getElementById('loadingText');
        const saveArea = document.getElementById('saveRecipeArea');

        resultDiv.innerHTML = '';
        saveArea.classList.add('d-none');
        loadingDiv.classList.remove('d-none');
        loadingText.innerText = loadingMsg;

        fetch(endpoint, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingDiv.classList.add('d-none');
            
            if (data.error) {
                resultDiv.innerHTML = '<span class="text-danger">å‡ºé”™äº†: ' + data.error + '</span>';
                return;
            }

            // Construct Display HTML based on JSON data
            let htmlContent = '';
            
            // Comment (for Omakase or general comment)
            if (data.comment) {
                htmlContent += `<div class="mb-3 fst-italic text-secondary" style="border-left: 3px solid #c5a059; padding-left: 10px;">${data.comment.replace(/\n/g, '<br>')}</div>`;
            }
            
            // Name
            if (data.name) {
                htmlContent += `<h5 class="text-dark fw-bold mb-3">ğŸ¸ ${data.name}</h5>`;
            }
            
            // Ingredients
            if (data.ingredients) {
                htmlContent += `<h6>ğŸ“ é…æ–¹ï¼š</h6><p class="small mb-3" style="white-space: pre-wrap;">${data.ingredients}</p>`;
            }
            
            // Instructions
            if (data.instructions) {
                htmlContent += `<h6>ğŸ¥£ æ­¥éª¤ï¼š</h6><p class="small text-muted" style="white-space: pre-wrap;">${data.instructions}</p>`;
            }
            
            // Ending (Omakase specific)
            if (data.ending) {
                htmlContent += `<div class="mt-3 text-end small text-secondary">"${data.ending}"</div>`;
            }
            
            // Fallback if data is not structured properly (e.g. error message string in name)
            if (!htmlContent) {
                htmlContent = JSON.stringify(data);
            }

            resultDiv.innerHTML = htmlContent;
            
            // Fill Hidden Inputs for Save
            document.getElementById('saveName').value = data.name || "æœªå‘½åé…æ–¹";
            document.getElementById('saveIngredients').value = data.ingredients || "";
            document.getElementById('saveInstructions').value = data.instructions || "";
            
            // Fill Visible Name Input
            document.getElementById('recipeNameInput').value = data.name || "";
            
            saveArea.classList.remove('d-none');
        })
        .catch(err => {
            loadingDiv.classList.add('d-none');
            resultDiv.innerHTML = 'å‡ºé”™äº†: ' + err;
        });
    }

    // Direct Ask
    document.getElementById('btnAskAI').addEventListener('click', function() {
        const req = document.getElementById('userRequest').value;
        const formData = new FormData();
        formData.append('user_request', req);
        requestAI('/suggest', formData);
    });

    // Omakase Ask
    document.getElementById('btnOmakase').addEventListener('click', function() {
        const mood = document.getElementById('omakaseMood').value;
        const weather = document.getElementById('omakaseWeather').value;
        const formData = new FormData();
        formData.append('mood', mood);
        formData.append('weather', weather);
        requestAI('/omakase', formData, "Kenji æ­£åœ¨æ“¦æ‹­é…’æ¯ï¼Œæ€è€ƒäººç”Ÿ...");
    });

    function submitRecipe() {
        const name = document.getElementById('recipeNameInput').value;
        if(!name) { alert('è¯·å¡«å†™é…æ–¹åç§°'); return; }
        
        document.getElementById('saveName').value = name;
        // æäº¤è¡¨å•
        document.querySelector('#saveRecipeArea form').submit();
    }
    
    // Auto-activate tab based on URL hash
    document.addEventListener("DOMContentLoaded", function() {
        var hash = window.location.hash;
        if (hash) {
            var triggerEl = document.querySelector('.nav-link[data-bs-target="' + hash + '"]');
            if (triggerEl) {
                var tab = new bootstrap.Tab(triggerEl);
                tab.show();
            }
        }
    });
</script>
</body>
</html>
