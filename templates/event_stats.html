<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ event.name }} - é¥®é…’ç»Ÿè®¡ ğŸ“Š</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* Specific overrides for stats page if needed */
        body { background-image: none; background-color: #f4f1ea; } /* Stats page can be lighter or keep dark */
        .stat-card { margin-bottom: 20px; }
        .text-white { color: var(--text-dark) !important; }
        .navbar-text { color: var(--accent-gold) !important; }

        /* Share Card Style (Hidden by default or shown in modal) */
        #shareCardContainer {
            background-color: #fffaf0;
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d9d9d9' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
            padding: 40px;
            border: 8px double #b8860b;
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            font-family: 'Noto Serif SC', 'Songti SC', serif;
            color: #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }
        /* Corner decoration */
        #shareCardContainer::before, #shareCardContainer::after {
            content: "âœ¦";
            position: absolute;
            color: #b8860b;
            font-size: 20px;
        }
        #shareCardContainer::before { top: 10px; left: 10px; }
        #shareCardContainer::after { bottom: 10px; right: 10px; }

        .share-card-header {
            text-align: center;
            border-bottom: 2px solid #b8860b;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .share-card-title {
            font-size: 2rem;
            font-weight: 700;
            color: #b8860b;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        .share-card-date {
            font-size: 0.9rem;
            color: #666;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        .share-card-body {
            padding: 10px 0;
        }
        .share-section-title {
            font-weight: bold;
            text-align: center;
            color: #b8860b;
            margin: 25px 0 10px;
            font-size: 1.1rem;
            position: relative;
        }
        .share-section-title::before, .share-section-title::after {
            content: "â€”";
            margin: 0 10px;
            color: #ddd;
        }
        .share-stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 1px dotted #ccc;
            padding-bottom: 2px;
            font-size: 1rem;
        }
        .share-summary {
            font-style: italic;
            line-height: 1.8;
            color: #4a4a4a;
            background: rgba(184, 134, 11, 0.05);
            padding: 20px;
            border-left: 3px solid #b8860b;
            margin-top: 30px;
            font-size: 0.95rem;
            text-align: justify;
        }
        .share-footer {
            text-align: center;
            margin-top: 40px;
            font-size: 0.75rem;
            color: #aaa;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">ğŸ”™ è¿”å›é¦–é¡µ</a>
        <span class="navbar-text text-white">{{ event.name }} ({{ event.date }})</span>
        <button class="btn btn-outline-warning btn-sm" onclick="generateShareCard()">ğŸ“¸ ç”Ÿæˆé…’å•å¡ç‰‡</button>
    </div>
</nav>

<div class="container">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-4">{{ event.name }} æˆ˜æŠ¥</h1>
            <p class="lead text-muted">{{ event.description }}</p>
            <div class="badge bg-primary fs-5">æ€»æ¶ˆè€—: {{ stats.total_drinks }} æ¯</div>
        </div>
    </div>

    <div class="row">
        <!-- Top Drinks Chart -->
        <div class="col-md-6">
            <div class="card stat-card p-3">
                <h4 class="card-title text-center">å¤§å®¶éƒ½åœ¨å–ä»€ä¹ˆï¼Ÿ</h4>
                <canvas id="drinksChart"></canvas>
            </div>
        </div>

        <!-- Participant Stats -->
        <div class="col-md-6">
            <div class="card stat-card p-3">
                <h4 class="card-title text-center">è°æ˜¯é…’ç¥ï¼Ÿ</h4>
                <div class="list-group list-group-flush mt-3">
                    {% for name, data in stats.by_participant.items()|sort(attribute='1.count', reverse=True) %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">{{ name }}</h5>
                            <small class="text-muted">{{ data.drinks | join(', ') }}</small>
                        </div>
                        <span class="badge bg-danger rounded-pill fs-6">{{ data.count }} æ¯</span>
                    </div>
                    {% else %}
                    <div class="text-center text-muted">è¿˜æ²¡äººå¼€å§‹å–...</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Ingredient Usage Stats -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card stat-card p-3">
                <h4 class="card-title text-center">åŸæ–™æ¶ˆè€—ä¸€è§ˆ (ä¼°ç®—)</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover text-center">
                        <thead class="table-dark text-white">
                            <tr>
                                <th class="text-white">åŸæ–™åç§°</th>
                                <th class="text-white">æ€»æ¶ˆè€—é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for name_unit, amount in stats.ingredient_usage %}
                            <tr>
                                <td>{{ name_unit }}</td>
                                <td class="fw-bold">{{ amount }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="2" class="text-muted">æš‚æ— åŸæ–™æ•°æ® (è¯·ç¡®ä¿è®°å½•æ—¶å…³è”äº†è¯¦ç»†é…æ–¹)</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Card Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">é¢„è§ˆåˆ†äº«å¡ç‰‡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" style="background: #eee;">
                 <div id="shareCardLoading" class="my-5">
                    <div class="spinner-border text-warning" role="status"></div>
                    <p class="mt-2">AI æ­£åœ¨æ’°å†™æ€»ç»“...</p>
                 </div>
                 
                 <!-- The Card (Initially Hidden) -->
                 <div id="shareCardContainer" class="d-none text-start">
                     <div class="share-card-header">
                         <div class="share-card-title">{{ event.name }}</div>
                         <div class="share-card-date">{{ event.date }}</div>
                     </div>
                     <div class="share-card-body">
                         <div class="share-section-title">ä»Šå¤œé…’å•</div>
                         <div id="shareTopDrinks">
                             <!-- JS will populate -->
                         </div>
                         
                         <div class="share-section-title">ä»Šæ—¥é…’ç¥</div>
                         <div class="share-stat-item">
                             <span id="shareMvpName">...</span>
                             <span id="shareMvpCount" class="badge bg-warning text-dark">...</span>
                         </div>
                         
                         <div class="share-summary" id="shareSummaryText">
                             <!-- AI Summary -->
                         </div>
                     </div>
                     <div class="share-footer">
                         Generated by ğŸ¸ ClamHelper
                     </div>
                 </div>
                 
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="downloadCard()" id="btnDownload" disabled>ğŸ“¥ ä¿å­˜å›¾ç‰‡</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Prepare data for Chart.js
    const drinkLabels = [{% for name, count in stats.top_drinks %}"{{ name }}",{% endfor %}];
    const drinkData = [{% for name, count in stats.top_drinks %}{{ count }},{% endfor %}];

    if (drinkLabels.length > 0) {
        const ctx = document.getElementById('drinksChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: drinkLabels,
                datasets: [{
                    label: 'æ¶ˆè€—æ•°é‡',
                    data: drinkData,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    } else {
        document.getElementById('drinksChart').parentElement.innerHTML += '<p class="text-center text-muted mt-5">æš‚æ— æ•°æ®</p>';
        document.getElementById('drinksChart').remove();
    }

    // Share Card Logic
    function generateShareCard() {
        const modal = new bootstrap.Modal(document.getElementById('shareModal'));
        modal.show();
        
        // Reset UI
        document.getElementById('shareCardLoading').classList.remove('d-none');
        document.getElementById('shareCardContainer').classList.add('d-none');
        document.getElementById('btnDownload').disabled = true;
        
        // Fetch Summary
        fetch('/event/{{ event.id }}/get_summary', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                // Populate Data
                document.getElementById('shareSummaryText').innerText = data.summary;
                document.getElementById('shareMvpName').innerText = data.mvp || "å¤§å®¶éƒ½å¾ˆå…‹åˆ¶";
                document.getElementById('shareMvpCount').innerText = data.mvp ? data.mvp_count + " æ¯" : "-";
                
                // Populate Top Drinks
                const drinksContainer = document.getElementById('shareTopDrinks');
                drinksContainer.innerHTML = '';
                if (data.top_drinks && data.top_drinks.length > 0) {
                    data.top_drinks.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'share-stat-item';
                        div.innerHTML = `<span>${item[0]}</span> <span>${item[1]}</span>`;
                        drinksContainer.appendChild(div);
                    });
                } else {
                    drinksContainer.innerHTML = '<div class="text-center text-muted small">æš‚æ— æ•°æ®</div>';
                }

                // Show Card
                document.getElementById('shareCardLoading').classList.add('d-none');
                document.getElementById('shareCardContainer').classList.remove('d-none');
                document.getElementById('btnDownload').disabled = false;
            })
            .catch(err => {
                console.error(err);
                document.getElementById('shareCardLoading').innerHTML = '<p class="text-danger">ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            });
    }

    function downloadCard() {
        const card = document.getElementById('shareCardContainer');
        html2canvas(card, {
            scale: 2, // High resolution
            useCORS: true,
            backgroundColor: null // Transparent background if set in CSS, but we have bg color
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'ClamHelper-Menu-{{ event.date }}.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }
</script>

</body>
</html>
